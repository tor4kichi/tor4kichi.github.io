
# Starryboardの使い方

## アプリ外でffmpegを使わなきゃいけない理由

ffmpegのライセンス料支払いを回避したいので各個人として利用していただく形をとっています。
簡単にインストールする方法も紹介していますので諦めずにお付き合いください。


## 動画とチャプターを結合するには

### 流れ

1. ffmpegのインストール（後ほどステップバイステップで説明します）
2. Starryboardから動画とチャプターテキストをエクスポート
3. チャプターテキストと共に出力された `merge-video.bat` を実行する

一度ffmpegの準備が終わればアプリから出力したものを何度かクリックするだけで済むようになります。

## 1. ffmpegをインストールしよう

> 既にインストール済みであればスキップできます。その場合、Windowsの環境変数（PATH）にffmpegが登録されている必要があります。PATHに未登録の場合は以下の手順でインストールしていきましょう。

Windowsに備え付けのパッケージマネージャ機能を使って少ない手間でインストールできます

インストールには 170MBほどのストレージ容量 が必要になります

手順
* キーボードの Windowsキー と Sキー を同時に押します（Windows内の検索機能を呼び出します）
* `cmd` と打ち込んでエンターキーを押します（コマンドプロンプトを起動します）
* 黒いウィンドウが表示されるので `winget install ffmpeg` と入力してエンターキーを押します（ffmpegをインストールします）
  * もし winget がインストールされていない場合は以下からインストールします
  * [Windows アプリインストーラー](https://apps.microsoft.com/detail/9nblggh4nns1?rtc=1&hl=ja-jp&gl=JP)
  * アプリインストーラーに関する追加の説明
    * https://learn.microsoft.com/ja-jp/windows/package-manager/winget/
* ffmpegのライセンスへの同意を求められるので`Y`を入力しエンターキーを押します
* インストールが進んでいきます。完了まで少し待ちます
* この手順はスキップできます）ffmpegがインストールできたかを確認したい場合は
  * インストールが完了したら一度黒いウィンドウを閉じて、再度黒いウィンドウを開きます（WindowsキーとSキーを同時押しした後 `cmd` と打ち込んでエンターキーを押す）
  * 黒いウィンドウに `ffmpeg` と入力してエンターキーを押します。バージョンやコピーライトなどがずらずらっと表示されたら正常にインストールできています
* インストールが完了したら黒いウィンドウを閉じて構いません


## 2. Starryboardから動画とチャプターテキストをエクスポート

動画はエクスポート方法「動画コンテ」を追加すると出力できます。ここではチャプターテキストについて説明していきます。

### 2.1. エピソードに「シーン区切り」（＝チャプター）を追加する

絵コンテのカットに「シーン区切りに指定」を指定すると、エクスポート時に動画用チャプターとして認識されます。シーン区切りまでの区間を自動でチャプターの時間として計算してくれます。

カットをシーン区切りに指定する操作方法は…
* カット一覧ページでは
  * カット番号をクリックすると表示されるアイテムメニュー
* カット編集ページでは
  * カットアイテムを右クリックして表示されるアイテムメニュー
  
のいずれかから「シーン区切りに指定」を選択します。同じカットに対してもう一度「シーン区切りに指定」を選択すると指定を解除できます。

シーン区切りに指定されたカットから次のシーン区切りに指定されたカットまでをチャプターとして認識して動画用チャプターテキストが出力されます。

### 2.2. エクスポート方法から「動画用チャプターテキスト」を追加する

### 2.3 エクスポートして出力を確認

## 3 `merge-video.bat` を実行する

### 3.1 merge-video.batの説明

参考例）
`ffmpeg -y -i test_2024-09-28.mp4 -i test_chapters_2024-09-28.txt -map_metadata 1 -c copy test_chapters_2024-09-28.mp4`

説明
* 一つ目の `-i` の後ろにあるファイル名が入力したい動画ファイル名です
* 二つ目の `-i` の後ろはチャプターテキストのファイル名です
* `-c copy`の後ろにあるファイル名が出力したいファイル名です
* `-y` 確認無しに出力ファイルを上書きする
* `-i` 入力ファイルの指定する
* `-c copy`の指定は動画や音声をそのままコピーするオプションです
* `-map_metadata 1` 1番目（0始まりのため二つ目の `-i` の後ろ）に指定されたファイルを使ってメタデータを設定するオプションです

### 3.2 merge-video.batの使い方

エクスプローラーから `merge-video_{日付}.bat` をダブルクリックすると実行できます。

ファイルを右クリックして「メモ帳で編集」を選ぶとどんな処理が実行されるのか中身を確認できます。

> 確認）WindowsのSmartScreen機能によって.batファイルの実行が止められます。表示された「詳細情報」部分をクリックすると「実行」ボタンが表示されますので押すとそのまま処理を進められます。
> 
> あくまで安全に実行できると考えていますが、セキュリティ的な確認ポイントは
> 
> * 本ページで紹介した手順でインストールした ffmpeg は安全であるか
> * Starryboardアプリが出力した .bat ファイルに不正な指令が含まれていないか
> * Starryboardアプリが出力したmp4やchapter.txtにffmpegの脆弱性等を利用した動作が含まれていないか
> 
> の３点が懸念されます。それらについて説明すると
> 
> * winget経由でインストールしたffmpegがどうビルドしているのかの説明
>   * https://www.gyan.dev/ffmpeg/builds/#about-these-builds
> * Starryboardが出力する動画は UniversalWindowsPlatform SDK が提供する  MediaComposition 機能を通じて出力しています
> * .bat ファイルはメモ帳などで開いて確認できます。ffmpeg をオプションを付けて呼び出しています


## 参考ページ

* [ffmpeg Documentation](https://ffmpeg.org/ffmpeg.html)

* [ffmpeg metadata chapters - hhsprings document](https://hhsprings.bitbucket.io/docs/programming/examples/ffmpeg/metadata/chapters.html)

* [ffmpeg でメタデータを加える - ニコラボ](https://nico-lab.net/adding_metadata_with_ffmpeg/#python)

* [【Windows 11】PATHの設定なしでFFmpegをインストールする方法](https://roboin.io/article/2024/02/25/install-ffmpeg-to-windows/)

* [ffmpegの使い方やコマンド一覧をまとめました。動画リサイズ・静止画変換・フレーム補間について](https://photo-tea.com/p/17/ffmpeg-command-list/)